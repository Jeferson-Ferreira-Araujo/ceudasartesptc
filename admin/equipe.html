<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Equipe - Admin</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js"></script>
<script src="../assets/js/firebase.js"></script>
</head>
<body>
<div class="container py-4">
  <h3>Gerenciar Equipe</h3>
  <input type="file" id="fileFoto" class="form-control mb-2">
  <input id="nome" class="form-control mb-2" placeholder="Nome">
  <input id="cargo" class="form-control mb-2" placeholder="Cargo">
  <input id="ord" class="form-control mb-2" placeholder="Ordem (1,2,3)">
  <button id="btnAdd" class="btn btn-primary">Adicionar</button>
  <hr>
  <div id="lista"></div>
</div>

<script>
function listar(){
  firebase.firestore().collection('equipe').orderBy('ord','asc').get().then(snap=>{
    let html='';
    snap.forEach(doc=>{
      const d = doc.data();
      html += '<div class="d-flex align-items-center mb-2"><img src="'+d.foto+'" height="60" class="me-3"><div><strong>'+d.nome+'</strong><div>'+d.cargo+'</div></div><button data-id="'+doc.id+'" class="btn btn-sm btn-danger ms-auto btnDel">Excluir</button></div>';
    });
    $("#lista").html(html);
  });
}
listar();

$("#btnAdd").click(function(){
  const f = $("#fileFoto")[0].files[0];
  const nome = $("#nome").val();
  const cargo = $("#cargo").val();
  const ord = parseInt($("#ord").val()||0,10);
  if(!f || !nome) return alert('Preencha nome e escolha foto');
  const ref = firebase.storage().ref();
  const up = ref.child('equipe/'+Date.now()+'_'+f.name).put(f);
  up.on('state_changed', null, err=>alert(err.message), ()=>{
    up.snapshot.ref.getDownloadURL().then(url=>{
      firebase.firestore().collection('equipe').add({nome,cargo,foto:url,ord});
      listar();
      alert('Membro adicionado');
    });
  });
});

$(document).on('click','.btnDel',function(){
  const id = $(this).data('id');
  if(!confirm('Excluir?')) return;
  firebase.firestore().collection('equipe').doc(id).delete().then(()=>listar());
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Galeria - Admin</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js"></script>
<script src="../assets/js/firebase.js"></script>
</head>
<body>
<div class="container py-4">
  <h3>Galeria</h3>
  <input type="file" id="fileFoto" class="form-control mb-2">
  <button id="btnUpload" class="btn btn-primary">Upload</button>
  <hr>
  <div id="lista" class="row"></div>
</div>

<script>
function listar(){
  firebase.firestore().collection('galeria').orderBy('created','desc').get().then(snap=>{
    let html='';
    snap.forEach(doc=>{
      const d = doc.data();
      html += '<div class="col-md-3 mb-3"><div class="card"><img src="'+d.url+'" class="card-img-top"><div class="card-body text-center"><button data-id="'+doc.id+'" class="btn btn-sm btn-danger btnDel">Excluir</button></div></div></div>';
    });
    $("#lista").html(html);
  });
}
listar();

$("#btnUpload").click(function(){
  const f = $("#fileFoto")[0].files[0];
  if(!f) return alert('Escolha um arquivo');
  const ref = firebase.storage().ref();
  const up = ref.child('galeria/'+Date.now()+'_'+f.name).put(f);
  up.on('state_changed', null, err=>alert(err.message), ()=>{
    up.snapshot.ref.getDownloadURL().then(url=>{
      firebase.firestore().collection('galeria').add({url, created: firebase.firestore.FieldValue.serverTimestamp()});
      listar();
      alert('Imagem enviada');
    });
  });
});

$(document).on('click','.btnDel', function(){
  const id = $(this).data('id');
  if(!confirm('Excluir?')) return;
  firebase.firestore().collection('galeria').doc(id).delete().then(()=>listar());
});
</script>
</body>
</html>
